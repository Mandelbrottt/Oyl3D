name: Build Win64 Action

on:
  workflow_call:
    inputs:
      configuration:
        required: true
        type: string
      platform:
        required: true
        type: string
      toolset:
        required: true
        type: string

env:
  vulkan_sdk_version: 1.4.341.1
  solution_file_path: Oyl3D_vs2022.sln

jobs:
  build-win64:
    name: ${{ inputs.toolset }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      # https://github.com/actions/cache/blob/main/workarounds.md#improving-cache-restore-performance-on-windowsusing-cross-os-caching
      - if: ${{ runner.os == 'Windows' }}
        name: Use GNU tar
        shell: cmd
        run: |
          echo "Adding GNU tar to PATH"
          echo C:\Program Files\Git\usr\bin>>"%GITHUB_PATH%"

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: Source/Dependencies/**
          key: engine-source-dependencies-${{ runner.os }}-${{ hashFiles('Packages.lua') }}

      - name: Fetch Vulkan SDK version spec
        run: |
          Invoke-WebRequest -Uri "https://vulkan.lunarg.com/sdk/config/${{ env.vulkan_sdk_version }}/windows/config.json" -OutFile vulkan-sdk-config.json
          $vulkan_sdk_config = "${{ github.workspace }}/vulkan-sdk-config.json" -replace '\\', '/'
          Add-Content -Path "$env:GITHUB_ENV" -Value "vulkan_sdk_config=$vulkan_sdk_config"

      - name: Prepare Vulkan SDK
        uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-config-file: $vulkan_sdk_config
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-use-cache: true

      - name: Generate Solutions
        working-directory: ${{ github.workspace }}
        run: Binaries/ThirdParty/premake5 vs2022 --cc=${{ inputs.toolset }}

      - name: Build
        working-directory: ${{ github.workspace }}
        # Add additional options to the MSBuild command line here (like platform or verbosity level).
        # See https://docs.microsoft.com/visualstudio/msbuild/msbuild-command-line-reference
        run: >
          msbuild
          /maxCpuCount
          /property:Configuration=${{ inputs.configuration }}
          /property:Platform=${{ inputs.platform }}
          /verbosity:normal
          ${{ env.solution_file_path }}
