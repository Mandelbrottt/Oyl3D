name: Premake Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        build_configuration: [
          Debug,
          Development,
          Distribution,
          Profile,
        ]
        build_platform: [
          Editor,
          Standalone,
        ]
        compiler: [
          msc-v143,
          clang,
        ]
        exclude:
          - build_configuration: Distribution
            build_platform: Editor

    runs-on: windows-latest

    env:
      # vulkan_sdk: C:\VulkanSdk
      vulkan_sdk_version: 1.4.341.1
      solution_file_path: Oyl3D_vs2022.sln

    steps:
    - uses: actions/checkout@v4

    # https://github.com/actions/cache/blob/main/workarounds.md#improving-cache-restore-performance-on-windowsusing-cross-os-caching
    - if: ${{ runner.os == 'Windows' }}
      name: Use GNU tar
      shell: cmd
      run: |
        echo "Adding GNU tar to PATH"
        echo C:\Program Files\Git\usr\bin>>"%GITHUB_PATH%"

    - name: Cache Dependencies
      uses: actions/cache@v4
      with:
        path: Source/Dependencies/**
        key: engine-source-dependencies-${{ runner.os }}-${{ hashFiles('Packages.lua') }}

    # - name: Cache VulkanSDK
    #   uses: actions/cache@v4
    #   with:
    #     path: ${{ env.vulkan_sdk }}
    #     key: vulkan-sdk-${{ env.vulkan_sdk_version }}

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    # - name: Setup Vulkan
    #   run: |
    #       if (Test-Path -Path ${{ env.vulkan_sdk }}) {
    #         echo "Vulkan SDK already on disk"
    #         Exit 0
    #       }

    #       $version = "${{ env.vulkan_sdk_version }}"
    #       if ( [string]::IsNullOrEmpty($version) ) { $version = (Invoke-WebRequest -Uri "https://vulkan.lunarg.com/sdk/latest/windows.txt") }
    #       echo "Fetching Vulkan SDK Version $version"
          
    #       $ProgressPreference = 'SilentlyContinue'
    #       Invoke-WebRequest -Uri "https://sdk.lunarg.com/sdk/download/$version/windows/vulkan_sdk.exe" -OutFile VulkanSDK.exe
    #       echo Downloaded
    #       .\VulkanSDK.exe --root ${{ env.vulkan_sdk }} --accept-licenses --default-answer --confirm-command install
    
    - name: Fetch Vulkan SDK version spec
      run: |
        Invoke-WebRequest -Uri "https://vulkan.lunarg.com/sdk/config/${{ env.vulkan_sdk_version }}/windows/config.json" -OutFile vulkan-sdk-config.json
        $vulkan_sdk_config = "${{ github.workspace }}/vulkan-sdk-config.json" -replace '\\', '/'
        Add-Content -Path "$env:GITHUB_ENV" -Value "vulkan_sdk_config=$vulkan_sdk_config"
        
    - name: Prepare Vulkan SDK
      uses: humbletim/setup-vulkan-sdk@v1.2.1
      with:
        vulkan-config-file: $vulkan_sdk_config
        vulkan-components: Vulkan-Headers, Vulkan-Loader
        vulkan-use-cache: true

    - name: Generate Solutions
      working-directory: ${{ github.workspace }}
      run: Binaries/ThirdParty/premake5 vs2022 --cc=${{ matrix.compiler }}

    - name: Build
      working-directory: ${{ github.workspace }}
      # Add additional options to the MSBuild command line here (like platform or verbosity level).
      # See https://docs.microsoft.com/visualstudio/msbuild/msbuild-command-line-reference
      run: >
        msbuild
        /maxCpuCount
        /property:Configuration=${{ matrix.build_configuration }}
        /property:Platform=${{ matrix.build_platform }}
        /verbosity:normal
        ${{ env.solution_file_path }}
